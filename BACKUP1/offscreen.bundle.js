(()=>{console.log("OFFSCREEN: Starting (Supabase version without ES imports)...");const e="https://qasvqvtoyrucrwshojzd.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhc3ZxdnRveXJ1Y3J3c2hvanpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3Mjk5NzIsImV4cCI6MjA2MDMwNTk3Mn0.4HaleG-RqyEp-TgJ1Zhalm455AyN2nM57nDBa7iNHmY";let r,t,o,n=!1,i=null,a=null,u=null,c=!1,d=null;d=new Promise(((e,s)=>{t=e,o=s}));const l=document.getElementById("status");function g(e,s=!1){console.log(`OFFSCREEN STATUS: ${e}`),l&&(l.textContent=e,l.style.color=s?"red":"green")}function E(e){if(!e||!e.user)return void console.error("OFFSCREEN: handleAuthSuccess called with invalid session");const s=e.user;a===s.id&&c||(a=s.id,u=e,c=!0,console.log(`OFFSCREEN: Auth state change: SIGNED IN. UID: ${a}`),g(`Authenticated (User ID: ${a.substring(0,8)}...)`),f(a,"SIGNED_IN"),t&&(console.log("OFFSCREEN: Resolving authReadyPromise."),t(),t=null,o=null))}function m(e){if(console.error("OFFSCREEN: Auth Error:",e),null!==a||c){a=null,u=null,c=!1;const s=`Auth Error: ${e?.message||"Unknown auth error"}`;i||(i=s),g(`Auth Error: ${e?.message}`,!0),f(null,"SIGNED_OUT"),N(s),o&&(console.error("OFFSCREEN: Rejecting authReadyPromise."),o(new Error(s)),o=null,t=null),t||o||(d=new Promise(((e,s)=>{t=e,o=s})))}}async function S(){if(!r||!n)return{status:"error",message:"Supabase client not initialized"};if(c&&a)return console.log("OFFSCREEN: signInAnonymously called, but already authenticated."),{status:"success",userId:a};console.log("OFFSCREEN: Attempting anonymous sign-in..."),g("Authenticating..."),c||t||o?c||console.log("OFFSCREEN: Existing auth promise pending during sign-in request."):(console.log("OFFSCREEN: Creating new authReadyPromise for sign-in attempt."),d=new Promise(((e,s)=>{t=e,o=s})));try{console.log("OFFSCREEN: Calling supabase.auth.signInAnonymously()...");const{data:e,error:s}=await r.auth.signInAnonymously();if(console.log("OFFSCREEN: supabase.auth.signInAnonymously() completed.",{data:!!e,error:s?.message}),s)throw s;if(!e?.session||!e?.user)throw new Error("Sign-in response missing session or user data.");if(E(e.session),await d,console.log("OFFSCREEN: Auth promise resolved/rejected after sign-in call."),c&&a)return{status:"success",userId:a};throw new Error(i||"Auth state inconsistent after sign-in attempt.")}catch(e){console.error("OFFSCREEN: signInAnonymouslySupabase Catch Block:",e);const s=`Auth Sign-in Error: ${e.message||e.error_description||"Unknown error"}`;return m(new Error(s)),{status:"error",message:s}}}async function F(e){if(!r||!n)return{status:"error",message:"Supabase not initialized"};if(!e)return{status:"error",message:"Missing videoId"};try{console.log(`OFFSCREEN: Querying triggers for video_id: ${e}`);const{data:s,error:t,status:o}=await r.from("triggers").select("*").eq("video_id",e).eq("status","approved");if(t)throw t;return console.log(`OFFSCREEN: Found ${s?.length??0} triggers for videoId ${e}. Status: ${o}`),{status:"success",videoId:e,triggers:s||[]}}catch(s){return console.error(`OFFSCREEN: Supabase fetch error for videoId ${e}:`,s),g(`Error fetching triggers: ${s.message}`,!0),{status:"error",message:"PGRST"===s.code&&s.message.includes("JWT")?"Permission denied (Auth Issue).":`Supabase fetch error: ${s.message}`,code:s.code}}}async function R(e){if(!r||!n)return{status:"error",message:"Supabase not initialized"};console.log(`OFFSCREEN: addTrigger - Checking auth state (isAuthReady: ${c}). Waiting for authReadyPromise...`);try{await d,console.log(`OFFSCREEN: addTrigger - authReadyPromise resolved. Proceeding. (isAuthReady: ${c}, userId: ${a})`)}catch(e){return console.error(`OFFSCREEN: addTrigger - authReadyPromise rejected: ${e.message}`),{status:"error",message:`Authentication required: ${e.message}`}}if(!c||!a)return console.error("OFFSCREEN: addTrigger - Not authenticated after waiting."),{status:"error",message:"Not authenticated"};if(!e||!e.videoId||!e.categoryKey||"number"!=typeof e.startTime||"number"!=typeof e.endTime||e.endTime<=e.startTime)return{status:"error",message:"Invalid trigger data provided"};console.log(`OFFSCREEN: Attempting to add trigger for videoId: ${e.videoId}`);try{const s={video_id:e.videoId,category_key:e.categoryKey,start_time:e.startTime,end_time:e.endTime,submitted_by:a,status:"approved",score:0};console.log("OFFSCREEN: Inserting trigger data with explicit values:",s),console.log("OFFSCREEN: User ID being used:",a),console.log("OFFSCREEN: Calling supabase.from('triggers').insert()...");const{data:t,error:o}=await r.from("triggers").insert(s).select("id").single();if(console.log("OFFSCREEN: supabase.from('triggers').insert() call completed.",t),o)throw console.error("OFFSCREEN: Supabase insert returned an error object:",JSON.stringify(o)),o;const n=t?.id;if(!n)throw new Error("Insert succeeded but did not return an ID.");return console.log(`OFFSCREEN: Trigger submitted successfully with ID: ${n}`),g(`Trigger submitted for video ${e.videoId}`),{status:"success",triggerId:n,message:"Trigger submitted successfully"}}catch(s){return console.error(`OFFSCREEN: Catch block in addTrigger for ${e.videoId}:`,s),g(`Error adding trigger: ${s.message}`,!0),console.error("OFFSCREEN: Error details:",{errorCode:s.code,errorMessage:s.message,authState:{isAuthReady:c,currentUserId:a?.substring(0,8)+"..."}}),{status:"error",message:"PGRST"===s.code&&s.message.includes("JWT")?"Permission denied (Auth Issue).":"23514"===s.code&&s.message.includes("end_time_after_start_time")?"End time must be after start time.":"42501"===s.code?"Permission Denied. Please check if you're signed in and have proper permissions.":`Supabase insert error: ${s.message}`,code:s.code}}}async function h(e){if(!r||!n)return{status:"error",message:"Supabase not initialized"};if(!e?.triggerId||!e.voteType||!["up","down"].includes(e.voteType))return{status:"error",message:"Invalid vote data"};try{await d}catch(e){return{status:"error",message:`Authentication required: ${e.message}`}}if(!c||!a)return{status:"error",message:"Not authenticated"};console.log(`OFFSCREEN: Attempting to ${e.voteType}-vote trigger ${e.triggerId}`);try{const{error:s}=await r.rpc("handle_vote",{trigger_id_in:e.triggerId,user_id_in:a,vote_type_in:e.voteType});if(s)throw s;return console.log(`OFFSCREEN: Vote ${e.voteType} processed for trigger ${e.triggerId}`),g(`Vote recorded for trigger ${e.triggerId}`),{status:"success",message:"Vote recorded"}}catch(s){return console.error(`OFFSCREEN: Error processing vote for ${e.triggerId}:`,s),g(`Error voting: ${s.message}`,!0),{status:"error",message:"PGRST"===s.code&&s.message.includes("JWT")?"Permission denied (Auth Issue).":"42501"===s.code?"Permission Denied. Check function security or RLS.":`Supabase RPC error: ${s.message}`,code:s.code}}}async function I(e){if(!r||!n)return{status:"error",message:"Supabase not initialized"};if(!e?.message)return{status:"error",message:"Invalid feedback data (message required)"};let s=null;try{await d,c&&a&&(s=a)}catch(e){console.warn("OFFSCREEN: Could not confirm auth state before submitting feedback, submitting anonymously.",e.message),s=null}console.log(`OFFSCREEN: Attempting to add feedback (Authenticated: ${!!s})`);try{const t={name:e.name||null,email:e.email||null,message:e.message,submitted_by:s},{error:o}=await r.from("feedback").insert(t);if(o)throw o;return console.log("OFFSCREEN: Feedback submitted successfully."),g("Feedback submitted."),{status:"success",message:"Feedback submitted"}}catch(e){return console.error("OFFSCREEN: Error adding feedback:",e),g(`Error submitting feedback: ${e.message}`,!0),{status:"error",message:"PGRST"===e.code&&e.message.includes("JWT")?"Permission denied (Auth Issue).":"42501"===e.code?"Permission Denied. Check RLS policies.":`Supabase insert error: ${e.message}`,code:e.code}}}function N(e){console.error(`OFFSCREEN: Sending INIT_ERROR: ${e}`);try{chrome.runtime.sendMessage({type:"INIT_ERROR",error:e})}catch(e){console.warn("OFFSCREEN: Error sending INIT_ERROR:",e.message)}}function f(e,s){console.log(`OFFSCREEN: Sending AUTH_STATE_CHANGED: User=${e?e.substring(0,8)+"...":"null"}, Status=${s}`);try{chrome.runtime.sendMessage({type:"AUTH_STATE_CHANGED",userId:e,status:s})}catch(e){console.warn("OFFSCREEN: Error sending AUTH_STATE_CHANGED:",e.message)}}chrome.runtime.onMessage.addListener(((e,s,r)=>{const t=e?.type||"unknown",o=e.requestId;console.log(`OFFSCREEN Received: Type=${t}${o?` (ReqID: ${o})`:""} from background.`);const a={FIRESTORE_GET_TRIGGERS:F,FIRESTORE_ADD_TRIGGER:R,FIRESTORE_VOTE:h,FIRESTORE_ADD_FEEDBACK:I},u={SIGN_IN_ANONYMOUSLY:S},c={OFFSCREEN_PING:async()=>({status:"success",message:"pong"})};let d=null,l=null,g=!1;if(a[t]?(d=a[t],l="FIRESTORE_GET_TRIGGERS"===t?e.videoId:e.data,g=!0):u[t]?(d=u[t],l=e.data):c[t]&&(d=c[t],l=e.data),d)return(async s=>{let o;try{if(i&&"SIGN_IN_ANONYMOUSLY"!==t)throw new Error(`Supabase init error: ${i}`);if(!n&&"SIGN_IN_ANONYMOUSLY"!==t)throw new Error("Supabase client not initialized");console.log(`OFFSCREEN: Executing operation for ${t} (ReqID: ${s})`),o=await d(l),console.log(`OFFSCREEN: Result for ${t} (ReqID: ${s}):`,o)}catch(e){console.error(`OFFSCREEN: Error during operation ${t} (ReqID: ${s}):`,e),o={status:"error",message:e.message||`Operation failed for ${t}`}}try{g?chrome.runtime.sendMessage({type:"OPERATION_RESULT",originalType:t,result:o,videoId:e.videoId,requestId:s}):"function"==typeof r?(s&&"object"==typeof o&&null!==o&&(o.requestId=s),r(o)):console.warn(`OFFSCREEN: sendResponse invalid for ${t}`)}catch(e){console.error(`OFFSCREEN: Error sending ${g?"result":"response"} for ${t}:`,e)}})(o),!g;console.warn(`OFFSCREEN: Unhandled message type received: ${t}`);try{r({status:"error",message:`Unknown message type in offscreen: ${t}`,requestId:o})}catch(e){}return!1})),window.addEventListener("load",(function(){setTimeout((()=>{!async function(){g("Initializing Supabase client...");try{if(e.includes("<")||s.includes("<"))throw new Error("Supabase URL or Anon Key is missing or invalid.");r="undefined"!=typeof supabaseJs?supabaseJs.createClient(e,s,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1}}):window.supabase.createClient(e,s,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1}}),console.log("OFFSCREEN: Supabase client initialized."),n=!0,r&&(console.log("OFFSCREEN: Setting up Supabase Auth State Listener..."),r.auth.onAuthStateChange(((e,s)=>{switch(console.log(`OFFSCREEN: Supabase Auth Event: ${e}`),e){case"INITIAL_SESSION":s?E(s):console.log("OFFSCREEN: Initial session is null.");break;case"SIGNED_IN":case"TOKEN_REFRESHED":case"USER_UPDATED":s?E(s):m(new Error(`${e} event with null session`));break;case"SIGNED_OUT":case"USER_DELETED":m(new Error("SIGNED_OUT"===e?"User signed out":"User deleted"));break;default:console.log(`OFFSCREEN: Unhandled auth event: ${e}`)}}))),g("Supabase Initialized. Checking Auth..."),function(){console.log("OFFSCREEN: Sending OFFSCREEN_READY to background");try{chrome.runtime.sendMessage({type:"OFFSCREEN_READY"})}catch(e){console.warn("OFFSCREEN: Error sending READY signal:",e.message)}}();const{data:{session:t},error:o}=await r.auth.getSession();o&&console.error("OFFSCREEN: Error getting initial session:",o),t?(console.log("OFFSCREEN: Initial session found."),E(t)):console.log("OFFSCREEN: No initial session found. Waiting for auth state change or sign-in request.")}catch(e){console.error("OFFSCREEN: FATAL Supabase Initialization Error:",e),i=`Supabase Client Init Error: ${e.message}`,n=!1,g(`FATAL: Supabase Init Failed: ${e.message}`,!0),N(i),o&&(o(new Error(i)),o=null,t=null)}}()}),500)}));const p=setInterval((()=>{r&&!i&&chrome.runtime.sendMessage({type:"OFFSCREEN_PING"}).catch((e=>{}))}),2e4);self.addEventListener("unload",(()=>{console.log("OFFSCREEN: Unloading..."),p&&clearInterval(p)})),g("Offscreen script loaded. Initializing Supabase...",!1),console.log("OFFSCREEN: Script execution finished. Listeners attached.")})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFRQyxJQUFJLG9DQUFvQ3FILEtBQzdELEtBeERBbkcsRUFBYSwwQ0FzUHJCLFdBQTZCbkIsUUFBUUMsSUFBSSxvREFBcUQsSUFBTXNGLE9BQU9DLFFBQVFDLFlBQVksQ0FBRUMsS0FBTSxtQkFBc0IsQ0FBRSxNQUFPQyxHQUFLM0YsUUFBUW9GLEtBQUsseUNBQTBDTyxFQUFFdkUsUUFBVSxDQUFFLENBclB4T21HLEdBRUEsTUFBUS9FLE1BQU0sUUFBRWQsR0FBV0UsTUFBTzRGLFNBQXVCcEgsRUFBU3FDLEtBQUtnRixhQUNuRUQsR0FBZ0J4SCxRQUFRNEIsTUFBTSw0Q0FBNkM0RixHQUMzRTlGLEdBQ0ExQixRQUFRQyxJQUFJLHFDQUNad0IsRUFBa0JDLElBRWxCMUIsUUFBUUMsSUFBSSx5RkFFcEIsQ0FBRSxNQUFPMkIsR0FDTDVCLFFBQVE0QixNQUFNLGtEQUFtREEsR0FDakVwQixFQUFzQiwrQkFBK0JvQixFQUFNUixVQUMzRGIsR0FBd0IsRUFDeEJZLEVBQWEsZ0NBQWdDUyxFQUFNUixXQUFXLEdBQzlEYyxFQUFjMUIsR0FDVkYsSUFDQUEsRUFBZ0IsSUFBSTZCLE1BQU0zQixJQUMxQkYsRUFBa0IsS0FDbEJELEVBQW1CLEtBRTNCLENBQ0osQ0E4U1FxSCxFQUFvQixHQUNyQixJQUNQLElBRUEsTUFBTUMsRUFBb0JDLGFBQVksS0FDOUJ4SCxJQUFhSSxHQUNiK0UsT0FBT0MsUUFBUUMsWUFBWSxDQUFFQyxLQUFNLG1CQUFvQm1DLE9BQU1DLE9BQ2pFLEdBQ0QsS0FFSEMsS0FBS2pCLGlCQUFpQixVQUFVLEtBQzVCOUcsUUFBUUMsSUFBSSwyQkFDUjBILEdBQW1CSyxjQUFjTCxFQUFrQixJQUczRHhHLEVBQWEscURBQXFELEdBQ2xFbkIsUUFBUUMsSUFBSSw0RCIsInNvdXJjZXMiOlsid2VicGFjazovL3RyaWdnZXItd2FybmluZ3MtZXh0ZW5zaW9uLy4vb2Zmc2NyZWVuLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIG9mZnNjcmVlbi5qcyAtIE1vZGlmaWVkIHZlcnNpb24gd2l0aG91dCBFUyBpbXBvcnRzXG5jb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogU3RhcnRpbmcgKFN1cGFiYXNlIHZlcnNpb24gd2l0aG91dCBFUyBpbXBvcnRzKS4uLlwiKTtcblxuLy8gLS0tIFN1cGFiYXNlIENvbmZpZ3VyYXRpb24gLS0tXG5jb25zdCBTVVBBQkFTRV9VUkwgPSAnaHR0cHM6Ly9xYXN2cXZ0b3lydWNyd3Nob2p6ZC5zdXBhYmFzZS5jbyc7XG5jb25zdCBTVVBBQkFTRV9BTk9OX0tFWSA9ICdleUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKcGMzTWlPaUp6ZFhCaFltRnpaU0lzSW5KbFppSTZJbkZoYzNaeGRuUnZlWEoxWTNKM2MyaHZhbnBrSWl3aWNtOXNaU0k2SW1GdWIyNGlMQ0pwWVhRaU9qRTNORFEzTWprNU56SXNJbVY0Y0NJNk1qQTJNRE13TlRrM01uMC40SGFsZUctUnF5RXAtVGdKMVpoYWxtNDU1QXlOMm5NNTduREJhN2lOSG1ZJztcblxuLy8gLS0tIFN0YXRlIC0tLVxubGV0IHN1cGFiYXNlO1xubGV0IGlzU3VwYWJhc2VJbml0aWFsaXplZCA9IGZhbHNlO1xubGV0IGluaXRpYWxpemF0aW9uRXJyb3IgPSBudWxsO1xubGV0IGN1cnJlbnRVc2VySWQgPSBudWxsO1xubGV0IGN1cnJlbnRTZXNzaW9uID0gbnVsbDtcbmxldCBpc0F1dGhSZWFkeSA9IGZhbHNlO1xubGV0IGF1dGhSZWFkeVByb21pc2UgPSBudWxsO1xubGV0IHJlc29sdmVBdXRoUmVhZHk7XG5sZXQgcmVqZWN0QXV0aFJlYWR5O1xuYXV0aFJlYWR5UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICByZXNvbHZlQXV0aFJlYWR5ID0gcmVzb2x2ZTtcbiAgICByZWplY3RBdXRoUmVhZHkgPSByZWplY3Q7XG59KTtcblxuLy8gLS0tIEhUTUwgU3RhdHVzIEVsZW1lbnQgJiB1cGRhdGVTdGF0dXMgLS0tXG5jb25zdCBzdGF0dXNFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1cycpO1xuZnVuY3Rpb24gdXBkYXRlU3RhdHVzKG1lc3NhZ2UsIGlzRXJyb3IgPSBmYWxzZSkge1xuICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU4gU1RBVFVTOiAke21lc3NhZ2V9YCk7XG4gICAgaWYgKHN0YXR1c0VsZW1lbnQpIHtcbiAgICAgICAgc3RhdHVzRWxlbWVudC50ZXh0Q29udGVudCA9IG1lc3NhZ2U7XG4gICAgICAgIHN0YXR1c0VsZW1lbnQuc3R5bGUuY29sb3IgPSBpc0Vycm9yID8gJ3JlZCcgOiAnZ3JlZW4nO1xuICAgIH1cbn1cblxuLy8gLS0tIEluaXRpYWxpemF0aW9uICYgQXV0aCBIYW5kbGluZyAtLS1cbmFzeW5jIGZ1bmN0aW9uIGluaXRpYWxpemVTdXBhYmFzZSgpIHtcbiAgICB1cGRhdGVTdGF0dXMoXCJJbml0aWFsaXppbmcgU3VwYWJhc2UgY2xpZW50Li4uXCIpO1xuICAgIHRyeSB7XG4gICAgICAgIGlmICghU1VQQUJBU0VfVVJMIHx8ICFTVVBBQkFTRV9BTk9OX0tFWSB8fCBTVVBBQkFTRV9VUkwuaW5jbHVkZXMoJzwnKSB8fCBTVVBBQkFTRV9BTk9OX0tFWS5pbmNsdWRlcygnPCcpKSB7IFxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU3VwYWJhc2UgVVJMIG9yIEFub24gS2V5IGlzIG1pc3Npbmcgb3IgaW52YWxpZC5cIik7IFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBVc2UgdGhlIGdsb2JhbCBzdXBhYmFzZUpzIGZyb20gdGhlIHNjcmlwdCB0YWdcbiAgICAgICAgaWYgKHR5cGVvZiBzdXBhYmFzZUpzICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgc3VwYWJhc2UgPSBzdXBhYmFzZUpzLmNyZWF0ZUNsaWVudChTVVBBQkFTRV9VUkwsIFNVUEFCQVNFX0FOT05fS0VZLCB7IFxuICAgICAgICAgICAgICAgIGF1dGg6IHsgcGVyc2lzdFNlc3Npb246IHRydWUsIGF1dG9SZWZyZXNoVG9rZW46IHRydWUsIGRldGVjdFNlc3Npb25JblVybDogZmFsc2UgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBGYWxsYmFjayB0byBpbXBvcnRlZCBtb2R1bGUgaWYgYXZhaWxhYmxlXG4gICAgICAgICAgICBzdXBhYmFzZSA9IHdpbmRvdy5zdXBhYmFzZS5jcmVhdGVDbGllbnQoU1VQQUJBU0VfVVJMLCBTVVBBQkFTRV9BTk9OX0tFWSwgeyBcbiAgICAgICAgICAgICAgICBhdXRoOiB7IHBlcnNpc3RTZXNzaW9uOiB0cnVlLCBhdXRvUmVmcmVzaFRva2VuOiB0cnVlLCBkZXRlY3RTZXNzaW9uSW5Vcmw6IGZhbHNlIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogU3VwYWJhc2UgY2xpZW50IGluaXRpYWxpemVkLlwiKTsgXG4gICAgICAgIGlzU3VwYWJhc2VJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIHNldHVwQXV0aExpc3RlbmVyKCk7IFxuICAgICAgICB1cGRhdGVTdGF0dXMoXCJTdXBhYmFzZSBJbml0aWFsaXplZC4gQ2hlY2tpbmcgQXV0aC4uLlwiKTsgXG4gICAgICAgIHNlbmRSZWFkeVNpZ25hbCgpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgeyBkYXRhOiB7IHNlc3Npb24gfSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5nZXRTZXNzaW9uKCk7XG4gICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsgY29uc29sZS5lcnJvcihcIk9GRlNDUkVFTjogRXJyb3IgZ2V0dGluZyBpbml0aWFsIHNlc3Npb246XCIsIHNlc3Npb25FcnJvcik7IH1cbiAgICAgICAgaWYgKHNlc3Npb24pIHsgXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogSW5pdGlhbCBzZXNzaW9uIGZvdW5kLlwiKTsgXG4gICAgICAgICAgICBoYW5kbGVBdXRoU3VjY2VzcyhzZXNzaW9uKTsgXG4gICAgICAgIH0gZWxzZSB7IFxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IE5vIGluaXRpYWwgc2Vzc2lvbiBmb3VuZC4gV2FpdGluZyBmb3IgYXV0aCBzdGF0ZSBjaGFuZ2Ugb3Igc2lnbi1pbiByZXF1ZXN0LlwiKTsgXG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiT0ZGU0NSRUVOOiBGQVRBTCBTdXBhYmFzZSBJbml0aWFsaXphdGlvbiBFcnJvcjpcIiwgZXJyb3IpOyBcbiAgICAgICAgaW5pdGlhbGl6YXRpb25FcnJvciA9IGBTdXBhYmFzZSBDbGllbnQgSW5pdCBFcnJvcjogJHtlcnJvci5tZXNzYWdlfWA7IFxuICAgICAgICBpc1N1cGFiYXNlSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgICAgdXBkYXRlU3RhdHVzKGBGQVRBTDogU3VwYWJhc2UgSW5pdCBGYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gLCB0cnVlKTsgXG4gICAgICAgIHNlbmRJbml0RXJyb3IoaW5pdGlhbGl6YXRpb25FcnJvcik7XG4gICAgICAgIGlmIChyZWplY3RBdXRoUmVhZHkpIHsgXG4gICAgICAgICAgICByZWplY3RBdXRoUmVhZHkobmV3IEVycm9yKGluaXRpYWxpemF0aW9uRXJyb3IpKTsgXG4gICAgICAgICAgICByZWplY3RBdXRoUmVhZHkgPSBudWxsOyBcbiAgICAgICAgICAgIHJlc29sdmVBdXRoUmVhZHkgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGVBdXRoU3VjY2VzcyhzZXNzaW9uKSB7XG4gICAgIGlmICghc2Vzc2lvbiB8fCAhc2Vzc2lvbi51c2VyKSB7IGNvbnNvbGUuZXJyb3IoXCJPRkZTQ1JFRU46IGhhbmRsZUF1dGhTdWNjZXNzIGNhbGxlZCB3aXRoIGludmFsaWQgc2Vzc2lvblwiKTsgcmV0dXJuOyB9XG4gICAgIGNvbnN0IHVzZXIgPSBzZXNzaW9uLnVzZXI7XG4gICAgIGlmIChjdXJyZW50VXNlcklkICE9PSB1c2VyLmlkIHx8ICFpc0F1dGhSZWFkeSkge1xuICAgICAgICAgIGN1cnJlbnRVc2VySWQgPSB1c2VyLmlkOyBjdXJyZW50U2Vzc2lvbiA9IHNlc3Npb247IGlzQXV0aFJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgT0ZGU0NSRUVOOiBBdXRoIHN0YXRlIGNoYW5nZTogU0lHTkVEIElOLiBVSUQ6ICR7Y3VycmVudFVzZXJJZH1gKTsgdXBkYXRlU3RhdHVzKGBBdXRoZW50aWNhdGVkIChVc2VyIElEOiAke2N1cnJlbnRVc2VySWQuc3Vic3RyaW5nKDAsIDgpfS4uLilgKTsgc2VuZEF1dGhTdGF0ZUNoYW5nZShjdXJyZW50VXNlcklkLCAnU0lHTkVEX0lOJyk7XG4gICAgICAgICAgaWYgKHJlc29sdmVBdXRoUmVhZHkpIHsgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IFJlc29sdmluZyBhdXRoUmVhZHlQcm9taXNlLlwiKTsgcmVzb2x2ZUF1dGhSZWFkeSgpOyByZXNvbHZlQXV0aFJlYWR5ID0gbnVsbDsgcmVqZWN0QXV0aFJlYWR5ID0gbnVsbDsgfVxuICAgICB9XG59XG5cbmZ1bmN0aW9uIGhhbmRsZUF1dGhFcnJvcihlcnJvcikge1xuICAgICBjb25zb2xlLmVycm9yKFwiT0ZGU0NSRUVOOiBBdXRoIEVycm9yOlwiLCBlcnJvcik7XG4gICAgIGlmIChjdXJyZW50VXNlcklkICE9PSBudWxsIHx8IGlzQXV0aFJlYWR5KSB7XG4gICAgICAgICAgY3VycmVudFVzZXJJZCA9IG51bGw7IGN1cnJlbnRTZXNzaW9uID0gbnVsbDsgaXNBdXRoUmVhZHkgPSBmYWxzZTtcbiAgICAgICAgICBjb25zdCBhdXRoRXJyb3IgPSBgQXV0aCBFcnJvcjogJHtlcnJvcj8ubWVzc2FnZSB8fCAnVW5rbm93biBhdXRoIGVycm9yJ31gO1xuICAgICAgICAgIGlmICghaW5pdGlhbGl6YXRpb25FcnJvcikgaW5pdGlhbGl6YXRpb25FcnJvciA9IGF1dGhFcnJvcjtcbiAgICAgICAgICB1cGRhdGVTdGF0dXMoYEF1dGggRXJyb3I6ICR7ZXJyb3I/Lm1lc3NhZ2V9YCwgdHJ1ZSk7IHNlbmRBdXRoU3RhdGVDaGFuZ2UobnVsbCwgJ1NJR05FRF9PVVQnKTsgc2VuZEluaXRFcnJvcihhdXRoRXJyb3IpO1xuICAgICAgICAgIGlmIChyZWplY3RBdXRoUmVhZHkpIHsgY29uc29sZS5lcnJvcihcIk9GRlNDUkVFTjogUmVqZWN0aW5nIGF1dGhSZWFkeVByb21pc2UuXCIpOyByZWplY3RBdXRoUmVhZHkobmV3IEVycm9yKGF1dGhFcnJvcikpOyByZWplY3RBdXRoUmVhZHkgPSBudWxsOyByZXNvbHZlQXV0aFJlYWR5ID0gbnVsbDsgfVxuICAgICAgICAgIGlmICghcmVzb2x2ZUF1dGhSZWFkeSAmJiAhcmVqZWN0QXV0aFJlYWR5KSB7IGF1dGhSZWFkeVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7IHJlc29sdmVBdXRoUmVhZHkgPSByZXNvbHZlOyByZWplY3RBdXRoUmVhZHkgPSByZWplY3Q7IH0pOyB9XG4gICAgIH1cbn1cblxuZnVuY3Rpb24gc2V0dXBBdXRoTGlzdGVuZXIoKSB7XG4gICAgaWYgKCFzdXBhYmFzZSkgcmV0dXJuOyBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogU2V0dGluZyB1cCBTdXBhYmFzZSBBdXRoIFN0YXRlIExpc3RlbmVyLi4uXCIpO1xuICAgIHN1cGFiYXNlLmF1dGgub25BdXRoU3RhdGVDaGFuZ2UoKGV2ZW50LCBzZXNzaW9uKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU46IFN1cGFiYXNlIEF1dGggRXZlbnQ6ICR7ZXZlbnR9YCk7XG4gICAgICAgIHN3aXRjaChldmVudCkge1xuICAgICAgICAgICAgY2FzZSAnSU5JVElBTF9TRVNTSU9OJzogaWYgKHNlc3Npb24pIGhhbmRsZUF1dGhTdWNjZXNzKHNlc3Npb24pOyBlbHNlIGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBJbml0aWFsIHNlc3Npb24gaXMgbnVsbC5cIik7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnU0lHTkVEX0lOJzogY2FzZSAnVE9LRU5fUkVGUkVTSEVEJzogY2FzZSAnVVNFUl9VUERBVEVEJzogaWYgKHNlc3Npb24pIGhhbmRsZUF1dGhTdWNjZXNzKHNlc3Npb24pOyBlbHNlIGhhbmRsZUF1dGhFcnJvcihuZXcgRXJyb3IoYCR7ZXZlbnR9IGV2ZW50IHdpdGggbnVsbCBzZXNzaW9uYCkpOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1NJR05FRF9PVVQnOiBjYXNlICdVU0VSX0RFTEVURUQnOiBoYW5kbGVBdXRoRXJyb3IobmV3IEVycm9yKGV2ZW50ID09PSAnU0lHTkVEX09VVCcgPyBcIlVzZXIgc2lnbmVkIG91dFwiIDogXCJVc2VyIGRlbGV0ZWRcIikpOyBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6IGNvbnNvbGUubG9nKGBPRkZTQ1JFRU46IFVuaGFuZGxlZCBhdXRoIGV2ZW50OiAke2V2ZW50fWApO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNpZ25JbkFub255bW91c2x5U3VwYWJhc2UoKSB7XG4gICAgaWYgKCFzdXBhYmFzZSB8fCAhaXNTdXBhYmFzZUluaXRpYWxpemVkKSByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJTdXBhYmFzZSBjbGllbnQgbm90IGluaXRpYWxpemVkXCIgfTtcbiAgICBpZiAoaXNBdXRoUmVhZHkgJiYgY3VycmVudFVzZXJJZCkgeyBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogc2lnbkluQW5vbnltb3VzbHkgY2FsbGVkLCBidXQgYWxyZWFkeSBhdXRoZW50aWNhdGVkLlwiKTsgcmV0dXJuIHsgc3RhdHVzOiBcInN1Y2Nlc3NcIiwgdXNlcklkOiBjdXJyZW50VXNlcklkIH07IH1cbiAgICBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogQXR0ZW1wdGluZyBhbm9ueW1vdXMgc2lnbi1pbi4uLlwiKTsgdXBkYXRlU3RhdHVzKFwiQXV0aGVudGljYXRpbmcuLi5cIik7XG4gICAgaWYgKCFpc0F1dGhSZWFkeSAmJiAhcmVzb2x2ZUF1dGhSZWFkeSAmJiAhcmVqZWN0QXV0aFJlYWR5KSB7IGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBDcmVhdGluZyBuZXcgYXV0aFJlYWR5UHJvbWlzZSBmb3Igc2lnbi1pbiBhdHRlbXB0LlwiKTsgYXV0aFJlYWR5UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsgcmVzb2x2ZUF1dGhSZWFkeSA9IHJlc29sdmU7IHJlamVjdEF1dGhSZWFkeSA9IHJlamVjdDsgfSk7IH1cbiAgICBlbHNlIGlmICghaXNBdXRoUmVhZHkpIHsgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IEV4aXN0aW5nIGF1dGggcHJvbWlzZSBwZW5kaW5nIGR1cmluZyBzaWduLWluIHJlcXVlc3QuXCIpOyB9XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IENhbGxpbmcgc3VwYWJhc2UuYXV0aC5zaWduSW5Bbm9ueW1vdXNseSgpLi4uXCIpO1xuICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLnNpZ25JbkFub255bW91c2x5KCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBzdXBhYmFzZS5hdXRoLnNpZ25JbkFub255bW91c2x5KCkgY29tcGxldGVkLlwiLCB7IGRhdGE6ICEhZGF0YSwgZXJyb3I6IGVycm9yPy5tZXNzYWdlIH0pO1xuICAgICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yOyBpZiAoIWRhdGE/LnNlc3Npb24gfHwgIWRhdGE/LnVzZXIpIHRocm93IG5ldyBFcnJvcihcIlNpZ24taW4gcmVzcG9uc2UgbWlzc2luZyBzZXNzaW9uIG9yIHVzZXIgZGF0YS5cIik7XG4gICAgICAgIGhhbmRsZUF1dGhTdWNjZXNzKGRhdGEuc2Vzc2lvbik7IGF3YWl0IGF1dGhSZWFkeVByb21pc2U7IGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBBdXRoIHByb21pc2UgcmVzb2x2ZWQvcmVqZWN0ZWQgYWZ0ZXIgc2lnbi1pbiBjYWxsLlwiKTtcbiAgICAgICAgaWYoaXNBdXRoUmVhZHkgJiYgY3VycmVudFVzZXJJZCl7IHJldHVybiB7IHN0YXR1czogXCJzdWNjZXNzXCIsIHVzZXJJZDogY3VycmVudFVzZXJJZCB9OyB9XG4gICAgICAgIGVsc2UgeyB0aHJvdyBuZXcgRXJyb3IoaW5pdGlhbGl6YXRpb25FcnJvciB8fCBcIkF1dGggc3RhdGUgaW5jb25zaXN0ZW50IGFmdGVyIHNpZ24taW4gYXR0ZW1wdC5cIik7IH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgY29uc29sZS5lcnJvcihcIk9GRlNDUkVFTjogc2lnbkluQW5vbnltb3VzbHlTdXBhYmFzZSBDYXRjaCBCbG9jazpcIiwgZXJyb3IpO1xuICAgICAgICAgY29uc3QgYXV0aEVycm9yID0gYEF1dGggU2lnbi1pbiBFcnJvcjogJHtlcnJvci5tZXNzYWdlIHx8IGVycm9yLmVycm9yX2Rlc2NyaXB0aW9uIHx8ICdVbmtub3duIGVycm9yJ31gO1xuICAgICAgICAgaGFuZGxlQXV0aEVycm9yKG5ldyBFcnJvcihhdXRoRXJyb3IpKTsgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IGF1dGhFcnJvciB9O1xuICAgIH1cbn1cblxuLy8gLS0tIFN1cGFiYXNlIERhdGFiYXNlIE9wZXJhdGlvbnMgLS0tXG5hc3luYyBmdW5jdGlvbiBnZXRUcmlnZ2Vycyh2aWRlb0lkKSB7XG4gICAgaWYgKCFzdXBhYmFzZSB8fCAhaXNTdXBhYmFzZUluaXRpYWxpemVkKSByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJTdXBhYmFzZSBub3QgaW5pdGlhbGl6ZWRcIiB9O1xuICAgIGlmICghdmlkZW9JZCkgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IFwiTWlzc2luZyB2aWRlb0lkXCIgfTtcbiAgICB0cnkge1xuICAgICAgICBjb25zb2xlLmxvZyhgT0ZGU0NSRUVOOiBRdWVyeWluZyB0cmlnZ2VycyBmb3IgdmlkZW9faWQ6ICR7dmlkZW9JZH1gKTtcbiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciwgc3RhdHVzIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCd0cmlnZ2VycycpLnNlbGVjdCgnKicpLmVxKCd2aWRlb19pZCcsIHZpZGVvSWQpLmVxKCdzdGF0dXMnLCAnYXBwcm92ZWQnKTtcbiAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgY29uc29sZS5sb2coYE9GRlNDUkVFTjogRm91bmQgJHtkYXRhPy5sZW5ndGggPz8gMH0gdHJpZ2dlcnMgZm9yIHZpZGVvSWQgJHt2aWRlb0lkfS4gU3RhdHVzOiAke3N0YXR1c31gKTtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBcInN1Y2Nlc3NcIiwgdmlkZW9JZDogdmlkZW9JZCwgdHJpZ2dlcnM6IGRhdGEgfHwgW10gfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBPRkZTQ1JFRU46IFN1cGFiYXNlIGZldGNoIGVycm9yIGZvciB2aWRlb0lkICR7dmlkZW9JZH06YCwgZXJyb3IpOyB1cGRhdGVTdGF0dXMoYEVycm9yIGZldGNoaW5nIHRyaWdnZXJzOiAke2Vycm9yLm1lc3NhZ2V9YCwgdHJ1ZSk7XG4gICAgICAgIGNvbnN0IHVzZXJNZXNzYWdlID0gKGVycm9yLmNvZGUgPT09ICdQR1JTVCcgJiYgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnSldUJykpID8gXCJQZXJtaXNzaW9uIGRlbmllZCAoQXV0aCBJc3N1ZSkuXCIgOiBgU3VwYWJhc2UgZmV0Y2ggZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gO1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogdXNlck1lc3NhZ2UsIGNvZGU6IGVycm9yLmNvZGUgfTtcbiAgICB9XG59XG5cbi8vIEZJWEVEOiBVcGRhdGVkIGFkZFRyaWdnZXIgZnVuY3Rpb24gdG8gZW5zdXJlIHRyaWdnZXJzIGFyZSBhcHByb3ZlZCBhdXRvbWF0aWNhbGx5XG5hc3luYyBmdW5jdGlvbiBhZGRUcmlnZ2VyKHRyaWdnZXJEYXRhKSB7XG4gICAgaWYgKCFzdXBhYmFzZSB8fCAhaXNTdXBhYmFzZUluaXRpYWxpemVkKSByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJTdXBhYmFzZSBub3QgaW5pdGlhbGl6ZWRcIiB9O1xuICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU46IGFkZFRyaWdnZXIgLSBDaGVja2luZyBhdXRoIHN0YXRlIChpc0F1dGhSZWFkeTogJHtpc0F1dGhSZWFkeX0pLiBXYWl0aW5nIGZvciBhdXRoUmVhZHlQcm9taXNlLi4uYCk7XG4gICAgXG4gICAgdHJ5IHsgXG4gICAgICAgIGF3YWl0IGF1dGhSZWFkeVByb21pc2U7IFxuICAgICAgICBjb25zb2xlLmxvZyhgT0ZGU0NSRUVOOiBhZGRUcmlnZ2VyIC0gYXV0aFJlYWR5UHJvbWlzZSByZXNvbHZlZC4gUHJvY2VlZGluZy4gKGlzQXV0aFJlYWR5OiAke2lzQXV0aFJlYWR5fSwgdXNlcklkOiAke2N1cnJlbnRVc2VySWR9KWApOyBcbiAgICB9IGNhdGNoIChhdXRoRXJyb3IpIHsgXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYE9GRlNDUkVFTjogYWRkVHJpZ2dlciAtIGF1dGhSZWFkeVByb21pc2UgcmVqZWN0ZWQ6ICR7YXV0aEVycm9yLm1lc3NhZ2V9YCk7IFxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogYEF1dGhlbnRpY2F0aW9uIHJlcXVpcmVkOiAke2F1dGhFcnJvci5tZXNzYWdlfWAgfTsgXG4gICAgfVxuICAgIFxuICAgIGlmICghaXNBdXRoUmVhZHkgfHwgIWN1cnJlbnRVc2VySWQpIHsgXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJPRkZTQ1JFRU46IGFkZFRyaWdnZXIgLSBOb3QgYXV0aGVudGljYXRlZCBhZnRlciB3YWl0aW5nLlwiKTsgXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogXCJlcnJvclwiLCBtZXNzYWdlOiBcIk5vdCBhdXRoZW50aWNhdGVkXCIgfTsgXG4gICAgfVxuICAgIFxuICAgIGlmICghdHJpZ2dlckRhdGEgfHwgIXRyaWdnZXJEYXRhLnZpZGVvSWQgfHwgIXRyaWdnZXJEYXRhLmNhdGVnb3J5S2V5IHx8IFxuICAgICAgICB0eXBlb2YgdHJpZ2dlckRhdGEuc3RhcnRUaW1lICE9PSAnbnVtYmVyJyB8fCB0eXBlb2YgdHJpZ2dlckRhdGEuZW5kVGltZSAhPT0gJ251bWJlcicgfHwgXG4gICAgICAgIHRyaWdnZXJEYXRhLmVuZFRpbWUgPD0gdHJpZ2dlckRhdGEuc3RhcnRUaW1lKSB7IFxuICAgICAgICByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJJbnZhbGlkIHRyaWdnZXIgZGF0YSBwcm92aWRlZFwiIH07IFxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU46IEF0dGVtcHRpbmcgdG8gYWRkIHRyaWdnZXIgZm9yIHZpZGVvSWQ6ICR7dHJpZ2dlckRhdGEudmlkZW9JZH1gKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgICAvLyBVc2Ugc25ha2VfY2FzZSBrZXlzIG1hdGNoaW5nIHRoZSBkYXRhYmFzZSBjb2x1bW5zLCBhbmQgRVhQTElDSVRMWSBzZXQgc3RhdHVzIHRvICdhcHByb3ZlZCdcbiAgICAgICAgY29uc3QgZG9jVG9BZGQgPSB7XG4gICAgICAgICAgICB2aWRlb19pZDogdHJpZ2dlckRhdGEudmlkZW9JZCxcbiAgICAgICAgICAgIGNhdGVnb3J5X2tleTogdHJpZ2dlckRhdGEuY2F0ZWdvcnlLZXksXG4gICAgICAgICAgICBzdGFydF90aW1lOiB0cmlnZ2VyRGF0YS5zdGFydFRpbWUsXG4gICAgICAgICAgICBlbmRfdGltZTogdHJpZ2dlckRhdGEuZW5kVGltZSxcbiAgICAgICAgICAgIHN1Ym1pdHRlZF9ieTogY3VycmVudFVzZXJJZCxcbiAgICAgICAgICAgIHN0YXR1czogJ2FwcHJvdmVkJywgLy8gRXhwbGljaXRseSBzZXQgdG8gYXBwcm92ZWRcbiAgICAgICAgICAgIHNjb3JlOiAwIC8vIEluaXRpYWxpemUgc2NvcmUgdG8gMFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IEluc2VydGluZyB0cmlnZ2VyIGRhdGEgd2l0aCBleHBsaWNpdCB2YWx1ZXM6XCIsIGRvY1RvQWRkKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IFVzZXIgSUQgYmVpbmcgdXNlZDpcIiwgY3VycmVudFVzZXJJZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBDYWxsaW5nIHN1cGFiYXNlLmZyb20oJ3RyaWdnZXJzJykuaW5zZXJ0KCkuLi5cIik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCd0cmlnZ2VycycpLmluc2VydChkb2NUb0FkZCkuc2VsZWN0KCdpZCcpLnNpbmdsZSgpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogc3VwYWJhc2UuZnJvbSgndHJpZ2dlcnMnKS5pbnNlcnQoKSBjYWxsIGNvbXBsZXRlZC5cIiwgZGF0YSk7XG5cbiAgICAgICAgaWYgKGVycm9yKSB7IFxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIk9GRlNDUkVFTjogU3VwYWJhc2UgaW5zZXJ0IHJldHVybmVkIGFuIGVycm9yIG9iamVjdDpcIiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IpKTsgXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjsgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG5ld1RyaWdnZXJJZCA9IGRhdGE/LmlkOyBcbiAgICAgICAgaWYgKCFuZXdUcmlnZ2VySWQpIHsgXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnNlcnQgc3VjY2VlZGVkIGJ1dCBkaWQgbm90IHJldHVybiBhbiBJRC5cIik7IFxuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coYE9GRlNDUkVFTjogVHJpZ2dlciBzdWJtaXR0ZWQgc3VjY2Vzc2Z1bGx5IHdpdGggSUQ6ICR7bmV3VHJpZ2dlcklkfWApOyBcbiAgICAgICAgdXBkYXRlU3RhdHVzKGBUcmlnZ2VyIHN1Ym1pdHRlZCBmb3IgdmlkZW8gJHt0cmlnZ2VyRGF0YS52aWRlb0lkfWApO1xuICAgICAgICByZXR1cm4geyBzdGF0dXM6IFwic3VjY2Vzc1wiLCB0cmlnZ2VySWQ6IG5ld1RyaWdnZXJJZCwgbWVzc2FnZTogXCJUcmlnZ2VyIHN1Ym1pdHRlZCBzdWNjZXNzZnVsbHlcIiB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYE9GRlNDUkVFTjogQ2F0Y2ggYmxvY2sgaW4gYWRkVHJpZ2dlciBmb3IgJHt0cmlnZ2VyRGF0YS52aWRlb0lkfTpgLCBlcnJvcik7XG4gICAgICAgIHVwZGF0ZVN0YXR1cyhgRXJyb3IgYWRkaW5nIHRyaWdnZXI6ICR7ZXJyb3IubWVzc2FnZX1gLCB0cnVlKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEltcHJvdmVkIGVycm9yIG1lc3NhZ2UgZGV0YWlscyBmb3IgZGVidWdnaW5nXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJPRkZTQ1JFRU46IEVycm9yIGRldGFpbHM6XCIsIHtcbiAgICAgICAgICAgIGVycm9yQ29kZTogZXJyb3IuY29kZSxcbiAgICAgICAgICAgIGVycm9yTWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgIGF1dGhTdGF0ZTogeyBpc0F1dGhSZWFkeSwgY3VycmVudFVzZXJJZDogY3VycmVudFVzZXJJZD8uc3Vic3RyaW5nKDAsIDgpICsgJy4uLicgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHVzZXJNZXNzYWdlID0gXG4gICAgICAgICAgICAoZXJyb3IuY29kZSA9PT0gJ1BHUlNUJyAmJiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdKV1QnKSkgPyBcbiAgICAgICAgICAgICAgICBcIlBlcm1pc3Npb24gZGVuaWVkIChBdXRoIElzc3VlKS5cIiA6XG4gICAgICAgICAgICAoZXJyb3IuY29kZSA9PT0gJzIzNTE0JyAmJiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdlbmRfdGltZV9hZnRlcl9zdGFydF90aW1lJykpID8gXG4gICAgICAgICAgICAgICAgXCJFbmQgdGltZSBtdXN0IGJlIGFmdGVyIHN0YXJ0IHRpbWUuXCIgOlxuICAgICAgICAgICAgKGVycm9yLmNvZGUgPT09ICc0MjUwMScpID8gXG4gICAgICAgICAgICAgICAgXCJQZXJtaXNzaW9uIERlbmllZC4gUGxlYXNlIGNoZWNrIGlmIHlvdSdyZSBzaWduZWQgaW4gYW5kIGhhdmUgcHJvcGVyIHBlcm1pc3Npb25zLlwiIDpcbiAgICAgICAgICAgICAgICBgU3VwYWJhc2UgaW5zZXJ0IGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IHVzZXJNZXNzYWdlLCBjb2RlOiBlcnJvci5jb2RlIH07XG4gICAgfVxufVxuXG4vLyBvZmZzY3JlZW4uanMgLSBVcGRhdGVkIHZvdGVUcmlnZ2VyIGZ1bmN0aW9uIHRvIGhhbmRsZSBzY29yZSBjaGFuZ2VzXG5hc3luYyBmdW5jdGlvbiB2b3RlVHJpZ2dlcih2b3RlRGF0YSkge1xuICAgIGlmICghc3VwYWJhc2UgfHwgIWlzU3VwYWJhc2VJbml0aWFsaXplZCkgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IFwiU3VwYWJhc2Ugbm90IGluaXRpYWxpemVkXCIgfTtcbiAgIGlmICghdm90ZURhdGE/LnRyaWdnZXJJZCB8fCAhdm90ZURhdGEudm90ZVR5cGUgfHwgIVsndXAnLCAnZG93biddLmluY2x1ZGVzKHZvdGVEYXRhLnZvdGVUeXBlKSkgeyBcbiAgICAgICByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJJbnZhbGlkIHZvdGUgZGF0YVwiIH07IFxuICAgfVxuICAgdHJ5IHsgXG4gICAgICAgYXdhaXQgYXV0aFJlYWR5UHJvbWlzZTsgXG4gICB9IGNhdGNoIChhdXRoRXJyb3IpIHsgXG4gICAgICAgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IGBBdXRoZW50aWNhdGlvbiByZXF1aXJlZDogJHthdXRoRXJyb3IubWVzc2FnZX1gIH07IFxuICAgfVxuICAgaWYgKCFpc0F1dGhSZWFkeSB8fCAhY3VycmVudFVzZXJJZCkgeyBcbiAgICAgICByZXR1cm4geyBzdGF0dXM6IFwiZXJyb3JcIiwgbWVzc2FnZTogXCJOb3QgYXV0aGVudGljYXRlZFwiIH07IFxuICAgfVxuICAgXG4gICBjb25zb2xlLmxvZyhgT0ZGU0NSRUVOOiBBdHRlbXB0aW5nIHRvICR7dm90ZURhdGEudm90ZVR5cGV9LXZvdGUgdHJpZ2dlciAke3ZvdGVEYXRhLnRyaWdnZXJJZH1gKTtcbiAgIHRyeSB7XG4gICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UucnBjKCdoYW5kbGVfdm90ZScsIHsgXG4gICAgICAgICAgIHRyaWdnZXJfaWRfaW46IHZvdGVEYXRhLnRyaWdnZXJJZCwgXG4gICAgICAgICAgIHVzZXJfaWRfaW46IGN1cnJlbnRVc2VySWQsIFxuICAgICAgICAgICB2b3RlX3R5cGVfaW46IHZvdGVEYXRhLnZvdGVUeXBlIFxuICAgICAgIH0pO1xuICAgICAgIFxuICAgICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7XG4gICAgICAgY29uc29sZS5sb2coYE9GRlNDUkVFTjogVm90ZSAke3ZvdGVEYXRhLnZvdGVUeXBlfSBwcm9jZXNzZWQgZm9yIHRyaWdnZXIgJHt2b3RlRGF0YS50cmlnZ2VySWR9YCk7IFxuICAgICAgIHVwZGF0ZVN0YXR1cyhgVm90ZSByZWNvcmRlZCBmb3IgdHJpZ2dlciAke3ZvdGVEYXRhLnRyaWdnZXJJZH1gKTtcbiAgICAgICByZXR1cm4geyBzdGF0dXM6IFwic3VjY2Vzc1wiLCBtZXNzYWdlOiBcIlZvdGUgcmVjb3JkZWRcIiB9O1xuICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICBjb25zb2xlLmVycm9yKGBPRkZTQ1JFRU46IEVycm9yIHByb2Nlc3Npbmcgdm90ZSBmb3IgJHt2b3RlRGF0YS50cmlnZ2VySWR9OmAsIGVycm9yKTsgXG4gICAgICAgdXBkYXRlU3RhdHVzKGBFcnJvciB2b3Rpbmc6ICR7ZXJyb3IubWVzc2FnZX1gLCB0cnVlKTtcbiAgICAgICBjb25zdCB1c2VyTWVzc2FnZSA9IChlcnJvci5jb2RlID09PSAnUEdSU1QnICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0pXVCcpKSA/IFxuICAgICAgICAgICBcIlBlcm1pc3Npb24gZGVuaWVkIChBdXRoIElzc3VlKS5cIiA6IFxuICAgICAgICAgICAoZXJyb3IuY29kZSA9PT0gJzQyNTAxJykgPyBcbiAgICAgICAgICAgICAgIFwiUGVybWlzc2lvbiBEZW5pZWQuIENoZWNrIGZ1bmN0aW9uIHNlY3VyaXR5IG9yIFJMUy5cIiA6IFxuICAgICAgICAgICAgICAgYFN1cGFiYXNlIFJQQyBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWA7XG4gICAgICAgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IHVzZXJNZXNzYWdlLCBjb2RlOiBlcnJvci5jb2RlIH07XG4gICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFkZEZlZWRiYWNrKGZlZWRiYWNrRGF0YSkge1xuICAgICBpZiAoIXN1cGFiYXNlIHx8ICFpc1N1cGFiYXNlSW5pdGlhbGl6ZWQpIHJldHVybiB7IHN0YXR1czogXCJlcnJvclwiLCBtZXNzYWdlOiBcIlN1cGFiYXNlIG5vdCBpbml0aWFsaXplZFwiIH07XG4gICAgaWYgKCFmZWVkYmFja0RhdGE/Lm1lc3NhZ2UpIHsgcmV0dXJuIHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IFwiSW52YWxpZCBmZWVkYmFjayBkYXRhIChtZXNzYWdlIHJlcXVpcmVkKVwiIH07IH1cbiAgICBsZXQgc3VibWl0dGVySWQgPSBudWxsO1xuICAgIHRyeSB7IGF3YWl0IGF1dGhSZWFkeVByb21pc2U7IGlmIChpc0F1dGhSZWFkeSAmJiBjdXJyZW50VXNlcklkKSBzdWJtaXR0ZXJJZCA9IGN1cnJlbnRVc2VySWQ7IH1cbiAgICBjYXRjaCAoYXV0aEVycm9yKSB7IGNvbnNvbGUud2FybihcIk9GRlNDUkVFTjogQ291bGQgbm90IGNvbmZpcm0gYXV0aCBzdGF0ZSBiZWZvcmUgc3VibWl0dGluZyBmZWVkYmFjaywgc3VibWl0dGluZyBhbm9ueW1vdXNseS5cIiwgYXV0aEVycm9yLm1lc3NhZ2UpOyBzdWJtaXR0ZXJJZCA9IG51bGw7IH1cbiAgICBjb25zb2xlLmxvZyhgT0ZGU0NSRUVOOiBBdHRlbXB0aW5nIHRvIGFkZCBmZWVkYmFjayAoQXV0aGVudGljYXRlZDogJHshIXN1Ym1pdHRlcklkfSlgKTtcbiAgICB0cnkge1xuICAgICAgICAvLyBVc2Ugc25ha2VfY2FzZSBmb3IgaW5zZXJ0IG9iamVjdCBrZXlzIHRvIG1hdGNoIERCIGNvbHVtbnNcbiAgICAgICAgY29uc3QgZG9jVG9BZGQgPSB7XG4gICAgICAgICAgICBuYW1lOiBmZWVkYmFja0RhdGEubmFtZSB8fCBudWxsLFxuICAgICAgICAgICAgZW1haWw6IGZlZWRiYWNrRGF0YS5lbWFpbCB8fCBudWxsLFxuICAgICAgICAgICAgbWVzc2FnZTogZmVlZGJhY2tEYXRhLm1lc3NhZ2UsXG4gICAgICAgICAgICBzdWJtaXR0ZWRfYnk6IHN1Ym1pdHRlcklkXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oJ2ZlZWRiYWNrJykuaW5zZXJ0KGRvY1RvQWRkKTtcbiAgICAgICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbiAgICAgICAgY29uc29sZS5sb2coYE9GRlNDUkVFTjogRmVlZGJhY2sgc3VibWl0dGVkIHN1Y2Nlc3NmdWxseS5gKTsgdXBkYXRlU3RhdHVzKGBGZWVkYmFjayBzdWJtaXR0ZWQuYCk7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogXCJzdWNjZXNzXCIsIG1lc3NhZ2U6IFwiRmVlZGJhY2sgc3VibWl0dGVkXCIgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBPRkZTQ1JFRU46IEVycm9yIGFkZGluZyBmZWVkYmFjazpgLCBlcnJvcik7IHVwZGF0ZVN0YXR1cyhgRXJyb3Igc3VibWl0dGluZyBmZWVkYmFjazogJHtlcnJvci5tZXNzYWdlfWAsIHRydWUpO1xuICAgICAgICBjb25zdCB1c2VyTWVzc2FnZSA9IChlcnJvci5jb2RlID09PSAnUEdSU1QnICYmIGVycm9yLm1lc3NhZ2UuaW5jbHVkZXMoJ0pXVCcpKSA/IFwiUGVybWlzc2lvbiBkZW5pZWQgKEF1dGggSXNzdWUpLlwiIDogKGVycm9yLmNvZGUgPT09ICc0MjUwMScpID8gXCJQZXJtaXNzaW9uIERlbmllZC4gQ2hlY2sgUkxTIHBvbGljaWVzLlwiIDogYFN1cGFiYXNlIGluc2VydCBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWA7XG4gICAgICAgIHJldHVybiB7IHN0YXR1czogXCJlcnJvclwiLCBtZXNzYWdlOiB1c2VyTWVzc2FnZSwgY29kZTogZXJyb3IuY29kZSB9O1xuICAgIH1cbn1cblxuLy8gLS0tIENvbW11bmljYXRpb24gZnVuY3Rpb25zIC0tLVxuZnVuY3Rpb24gc2VuZFJlYWR5U2lnbmFsKCkgeyBjb25zb2xlLmxvZyhcIk9GRlNDUkVFTjogU2VuZGluZyBPRkZTQ1JFRU5fUkVBRFkgdG8gYmFja2dyb3VuZFwiKTsgdHJ5IHsgY2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2UoeyB0eXBlOiBcIk9GRlNDUkVFTl9SRUFEWVwiIH0pOyB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybihcIk9GRlNDUkVFTjogRXJyb3Igc2VuZGluZyBSRUFEWSBzaWduYWw6XCIsIGUubWVzc2FnZSk7IH0gfVxuZnVuY3Rpb24gc2VuZEluaXRFcnJvcihlcnJvck1lc3NhZ2UpIHsgY29uc29sZS5lcnJvcihgT0ZGU0NSRUVOOiBTZW5kaW5nIElOSVRfRVJST1I6ICR7ZXJyb3JNZXNzYWdlfWApOyB0cnkgeyBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSh7IHR5cGU6IFwiSU5JVF9FUlJPUlwiLCBlcnJvcjogZXJyb3JNZXNzYWdlIH0pOyB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybihcIk9GRlNDUkVFTjogRXJyb3Igc2VuZGluZyBJTklUX0VSUk9SOlwiLCBlLm1lc3NhZ2UpOyB9IH1cbmZ1bmN0aW9uIHNlbmRBdXRoU3RhdGVDaGFuZ2UodXNlcklkLCBzdGF0dXMpIHsgY29uc29sZS5sb2coYE9GRlNDUkVFTjogU2VuZGluZyBBVVRIX1NUQVRFX0NIQU5HRUQ6IFVzZXI9JHt1c2VySWQgPyB1c2VySWQuc3Vic3RyaW5nKDAsOCkrJy4uLicgOiAnbnVsbCd9LCBTdGF0dXM9JHtzdGF0dXN9YCk7IHRyeSB7IGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgdHlwZTogXCJBVVRIX1NUQVRFX0NIQU5HRURcIiwgdXNlcklkOiB1c2VySWQsIHN0YXR1czogc3RhdHVzIH0pOyB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybihcIk9GRlNDUkVFTjogRXJyb3Igc2VuZGluZyBBVVRIX1NUQVRFX0NIQU5HRUQ6XCIsIGUubWVzc2FnZSk7IH0gfVxuXG4vLyAtLS0gTWVzc2FnZSBIYW5kbGluZyAtLS1cbmNocm9tZS5ydW50aW1lLm9uTWVzc2FnZS5hZGRMaXN0ZW5lcigobWVzc2FnZSwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpID0+IHtcbiAgICBjb25zdCBtZXNzYWdlVHlwZSA9IG1lc3NhZ2U/LnR5cGUgfHwgJ3Vua25vd24nO1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IG1lc3NhZ2UucmVxdWVzdElkO1xuICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU4gUmVjZWl2ZWQ6IFR5cGU9JHttZXNzYWdlVHlwZX0ke3JlcXVlc3RJZCA/IGAgKFJlcUlEOiAke3JlcXVlc3RJZH0pYCA6ICcnfSBmcm9tIGJhY2tncm91bmQuYCk7XG5cbiAgICAvLyBVc2UgRklSRVNUT1JFXyBwcmVmaXhlcyBmb3Iga2V5cyB0byBtYXRjaCB3aGF0IGJhY2tncm91bmQgc2NyaXB0IHNlbmRzXG4gICAgY29uc3QgZGF0YWJhc2VPcGVyYXRpb25zID0ge1xuICAgICAgICBcIkZJUkVTVE9SRV9HRVRfVFJJR0dFUlNcIjogZ2V0VHJpZ2dlcnMsXG4gICAgICAgIFwiRklSRVNUT1JFX0FERF9UUklHR0VSXCI6IGFkZFRyaWdnZXIsXG4gICAgICAgIFwiRklSRVNUT1JFX1ZPVEVcIjogdm90ZVRyaWdnZXIsXG4gICAgICAgIFwiRklSRVNUT1JFX0FERF9GRUVEQkFDS1wiOiBhZGRGZWVkYmFja1xuICAgIH07XG4gICAgY29uc3QgYXV0aE9wZXJhdGlvbnMgPSB7XG4gICAgICAgIFwiU0lHTl9JTl9BTk9OWU1PVVNMWVwiOiBzaWduSW5Bbm9ueW1vdXNseVN1cGFiYXNlXG4gICAgfTtcbiAgICBjb25zdCBvdGhlck9wZXJhdGlvbnMgPSB7XG4gICAgICAgIFwiT0ZGU0NSRUVOX1BJTkdcIjogYXN5bmMgKCkgPT4gKHsgc3RhdHVzOiBcInN1Y2Nlc3NcIiwgbWVzc2FnZTogXCJwb25nXCIgfSlcbiAgICB9O1xuXG4gICAgbGV0IG9wZXJhdGlvbiA9IG51bGw7XG4gICAgbGV0IHBheWxvYWQgPSBudWxsO1xuICAgIGxldCBpc0RiT3BlcmF0aW9uID0gZmFsc2U7XG5cbiAgICBpZiAoZGF0YWJhc2VPcGVyYXRpb25zW21lc3NhZ2VUeXBlXSkge1xuICAgICAgICBvcGVyYXRpb24gPSBkYXRhYmFzZU9wZXJhdGlvbnNbbWVzc2FnZVR5cGVdO1xuICAgICAgICBwYXlsb2FkID0gbWVzc2FnZVR5cGUgPT09ICdGSVJFU1RPUkVfR0VUX1RSSUdHRVJTJyA/IG1lc3NhZ2UudmlkZW9JZCA6IG1lc3NhZ2UuZGF0YTtcbiAgICAgICAgaXNEYk9wZXJhdGlvbiA9IHRydWU7XG4gICAgfSBlbHNlIGlmIChhdXRoT3BlcmF0aW9uc1ttZXNzYWdlVHlwZV0pIHtcbiAgICAgICAgb3BlcmF0aW9uID0gYXV0aE9wZXJhdGlvbnNbbWVzc2FnZVR5cGVdO1xuICAgICAgICBwYXlsb2FkID0gbWVzc2FnZS5kYXRhO1xuICAgIH0gZWxzZSBpZiAob3RoZXJPcGVyYXRpb25zW21lc3NhZ2VUeXBlXSkge1xuICAgICAgICBvcGVyYXRpb24gPSBvdGhlck9wZXJhdGlvbnNbbWVzc2FnZVR5cGVdO1xuICAgICAgICBwYXlsb2FkID0gbWVzc2FnZS5kYXRhO1xuICAgIH1cblxuICAgIGlmIChvcGVyYXRpb24pIHtcbiAgICAgICAgLy8gTm8gaW1tZWRpYXRlIGFjayBuZWVkZWQgbm93LCByZWx5aW5nIG9uIGFzeW5jIHJlc3VsdCBwYXNzaW5nXG4gICAgICAgIC8vIGlmIChpc0RiT3BlcmF0aW9uKSB7IHRyeSB7IHNlbmRSZXNwb25zZSh7IHN0YXR1czogXCJwcm9jZXNzaW5nXCIgfSk7IH0gY2F0Y2goZSkge30gfVxuXG4gICAgICAgIChhc3luYyAoY3VycmVudFJlcXVlc3RJZCkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgaWYgKGluaXRpYWxpemF0aW9uRXJyb3IgJiYgbWVzc2FnZVR5cGUgIT09ICdTSUdOX0lOX0FOT05ZTU9VU0xZJykgeyB0aHJvdyBuZXcgRXJyb3IoYFN1cGFiYXNlIGluaXQgZXJyb3I6ICR7aW5pdGlhbGl6YXRpb25FcnJvcn1gKTsgfVxuICAgICAgICAgICAgICAgICBpZiAoIWlzU3VwYWJhc2VJbml0aWFsaXplZCAmJiBtZXNzYWdlVHlwZSAhPT0gJ1NJR05fSU5fQU5PTllNT1VTTFknKSB7IHRocm93IG5ldyBFcnJvcihgU3VwYWJhc2UgY2xpZW50IG5vdCBpbml0aWFsaXplZGApOyB9XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE9GRlNDUkVFTjogRXhlY3V0aW5nIG9wZXJhdGlvbiBmb3IgJHttZXNzYWdlVHlwZX0gKFJlcUlEOiAke2N1cnJlbnRSZXF1ZXN0SWR9KWApO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gYXdhaXQgb3BlcmF0aW9uKHBheWxvYWQpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBPRkZTQ1JFRU46IFJlc3VsdCBmb3IgJHttZXNzYWdlVHlwZX0gKFJlcUlEOiAke2N1cnJlbnRSZXF1ZXN0SWR9KTpgLCByZXNwb25zZSk7XG4gICAgICAgICAgICB9IGNhdGNoIChvcEVycm9yKSB7XG4gICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYE9GRlNDUkVFTjogRXJyb3IgZHVyaW5nIG9wZXJhdGlvbiAke21lc3NhZ2VUeXBlfSAoUmVxSUQ6ICR7Y3VycmVudFJlcXVlc3RJZH0pOmAsIG9wRXJyb3IpO1xuICAgICAgICAgICAgICAgICByZXNwb25zZSA9IHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IG9wRXJyb3IubWVzc2FnZSB8fCBgT3BlcmF0aW9uIGZhaWxlZCBmb3IgJHttZXNzYWdlVHlwZX1gIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICBpZiAoaXNEYk9wZXJhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5ydW50aW1lLnNlbmRNZXNzYWdlKHsgdHlwZTogXCJPUEVSQVRJT05fUkVTVUxUXCIsIG9yaWdpbmFsVHlwZTogbWVzc2FnZVR5cGUsIHJlc3VsdDogcmVzcG9uc2UsIHZpZGVvSWQ6IG1lc3NhZ2UudmlkZW9JZCwgcmVxdWVzdElkOiBjdXJyZW50UmVxdWVzdElkIH0pO1xuICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VuZFJlc3BvbnNlID09PSAnZnVuY3Rpb24nKSB7IGlmIChjdXJyZW50UmVxdWVzdElkICYmIHR5cGVvZiByZXNwb25zZSA9PT0gJ29iamVjdCcgJiYgcmVzcG9uc2UgIT09IG51bGwpIHJlc3BvbnNlLnJlcXVlc3RJZCA9IGN1cnJlbnRSZXF1ZXN0SWQ7IHNlbmRSZXNwb25zZShyZXNwb25zZSk7IH1cbiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsgY29uc29sZS53YXJuKGBPRkZTQ1JFRU46IHNlbmRSZXNwb25zZSBpbnZhbGlkIGZvciAke21lc3NhZ2VUeXBlfWApOyB9XG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS5lcnJvcihgT0ZGU0NSRUVOOiBFcnJvciBzZW5kaW5nICR7aXNEYk9wZXJhdGlvbiA/ICdyZXN1bHQnIDogJ3Jlc3BvbnNlJ30gZm9yICR7bWVzc2FnZVR5cGV9OmAsIGUpOyB9XG4gICAgICAgIH0pKHJlcXVlc3RJZCk7XG5cbiAgICAgICAgcmV0dXJuICFpc0RiT3BlcmF0aW9uOyAvLyBSZXR1cm4gdHJ1ZSBvbmx5IGZvciBub24tREIgb3BzXG5cbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLndhcm4oYE9GRlNDUkVFTjogVW5oYW5kbGVkIG1lc3NhZ2UgdHlwZSByZWNlaXZlZDogJHttZXNzYWdlVHlwZX1gKTtcbiAgICAgICAgdHJ5IHsgc2VuZFJlc3BvbnNlKHsgc3RhdHVzOiBcImVycm9yXCIsIG1lc3NhZ2U6IGBVbmtub3duIG1lc3NhZ2UgdHlwZSBpbiBvZmZzY3JlZW46ICR7bWVzc2FnZVR5cGV9YCwgcmVxdWVzdElkOiByZXF1ZXN0SWQgfSk7IH0gY2F0Y2goZSkge31cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn0pO1xuXG4vLyAtLS0gSW5pdGlhbGl6YXRpb24gJiBLZWVwLUFsaXZlIC0tLVxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHtcbiAgICAvLyBTbWFsbCBkZWxheSB0byBlbnN1cmUgc3VwYWJhc2UgbGlicmFyeSBpcyBsb2FkZWRcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaW5pdGlhbGl6ZVN1cGFiYXNlKCk7XG4gICAgfSwgNTAwKTtcbn0pO1xuXG5jb25zdCBrZWVwQWxpdmVJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHsgXG4gICAgaWYgKHN1cGFiYXNlICYmICFpbml0aWFsaXphdGlvbkVycm9yKSB7IFxuICAgICAgICBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSh7IHR5cGU6IFwiT0ZGU0NSRUVOX1BJTkdcIiB9KS5jYXRjaChfID0+IHt9KTsgXG4gICAgfSBcbn0sIDIwMDAwKTtcblxuc2VsZi5hZGRFdmVudExpc3RlbmVyKCd1bmxvYWQnLCAoKSA9PiB7IFxuICAgIGNvbnNvbGUubG9nKFwiT0ZGU0NSRUVOOiBVbmxvYWRpbmcuLi5cIik7IFxuICAgIGlmIChrZWVwQWxpdmVJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbChrZWVwQWxpdmVJbnRlcnZhbCk7IFxufSk7XG5cbnVwZGF0ZVN0YXR1cyhcIk9mZnNjcmVlbiBzY3JpcHQgbG9hZGVkLiBJbml0aWFsaXppbmcgU3VwYWJhc2UuLi5cIiwgZmFsc2UpO1xuY29uc29sZS5sb2coXCJPRkZTQ1JFRU46IFNjcmlwdCBleGVjdXRpb24gZmluaXNoZWQuIExpc3RlbmVycyBhdHRhY2hlZC5cIik7Il0sIm5hbWVzIjpbImNvbnNvbGUiLCJsb2ciLCJTVVBBQkFTRV9VUkwiLCJTVVBBQkFTRV9BTk9OX0tFWSIsInN1cGFiYXNlIiwicmVzb2x2ZUF1dGhSZWFkeSIsInJlamVjdEF1dGhSZWFkeSIsImlzU3VwYWJhc2VJbml0aWFsaXplZCIsImluaXRpYWxpemF0aW9uRXJyb3IiLCJjdXJyZW50VXNlcklkIiwiY3VycmVudFNlc3Npb24iLCJpc0F1dGhSZWFkeSIsImF1dGhSZWFkeVByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInN0YXR1c0VsZW1lbnQiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwidXBkYXRlU3RhdHVzIiwibWVzc2FnZSIsImlzRXJyb3IiLCJ0ZXh0Q29udGVudCIsInN0eWxlIiwiY29sb3IiLCJoYW5kbGVBdXRoU3VjY2VzcyIsInNlc3Npb24iLCJ1c2VyIiwiZXJyb3IiLCJpZCIsInN1YnN0cmluZyIsInNlbmRBdXRoU3RhdGVDaGFuZ2UiLCJoYW5kbGVBdXRoRXJyb3IiLCJhdXRoRXJyb3IiLCJzZW5kSW5pdEVycm9yIiwiRXJyb3IiLCJhc3luYyIsInNpZ25JbkFub255bW91c2x5U3VwYWJhc2UiLCJzdGF0dXMiLCJ1c2VySWQiLCJkYXRhIiwiYXV0aCIsInNpZ25JbkFub255bW91c2x5IiwiZXJyb3JfZGVzY3JpcHRpb24iLCJnZXRUcmlnZ2VycyIsInZpZGVvSWQiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJsZW5ndGgiLCJ0cmlnZ2VycyIsImNvZGUiLCJpbmNsdWRlcyIsImFkZFRyaWdnZXIiLCJ0cmlnZ2VyRGF0YSIsImNhdGVnb3J5S2V5Iiwic3RhcnRUaW1lIiwiZW5kVGltZSIsImRvY1RvQWRkIiwidmlkZW9faWQiLCJjYXRlZ29yeV9rZXkiLCJzdGFydF90aW1lIiwiZW5kX3RpbWUiLCJzdWJtaXR0ZWRfYnkiLCJzY29yZSIsImluc2VydCIsInNpbmdsZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJuZXdUcmlnZ2VySWQiLCJ0cmlnZ2VySWQiLCJlcnJvckNvZGUiLCJlcnJvck1lc3NhZ2UiLCJhdXRoU3RhdGUiLCJ2b3RlVHJpZ2dlciIsInZvdGVEYXRhIiwidm90ZVR5cGUiLCJycGMiLCJ0cmlnZ2VyX2lkX2luIiwidXNlcl9pZF9pbiIsInZvdGVfdHlwZV9pbiIsImFkZEZlZWRiYWNrIiwiZmVlZGJhY2tEYXRhIiwic3VibWl0dGVySWQiLCJ3YXJuIiwibmFtZSIsImVtYWlsIiwiY2hyb21lIiwicnVudGltZSIsInNlbmRNZXNzYWdlIiwidHlwZSIsImUiLCJvbk1lc3NhZ2UiLCJhZGRMaXN0ZW5lciIsInNlbmRlciIsInNlbmRSZXNwb25zZSIsIm1lc3NhZ2VUeXBlIiwicmVxdWVzdElkIiwiZGF0YWJhc2VPcGVyYXRpb25zIiwiYXV0aE9wZXJhdGlvbnMiLCJvdGhlck9wZXJhdGlvbnMiLCJvcGVyYXRpb24iLCJwYXlsb2FkIiwiaXNEYk9wZXJhdGlvbiIsImN1cnJlbnRSZXF1ZXN0SWQiLCJyZXNwb25zZSIsIm9wRXJyb3IiLCJvcmlnaW5hbFR5cGUiLCJyZXN1bHQiLCJ3aW5kb3ciLCJhZGRFdmVudExpc3RlbmVyIiwic2V0VGltZW91dCIsInN1cGFiYXNlSnMiLCJjcmVhdGVDbGllbnQiLCJwZXJzaXN0U2Vzc2lvbiIsImF1dG9SZWZyZXNoVG9rZW4iLCJkZXRlY3RTZXNzaW9uSW5VcmwiLCJvbkF1dGhTdGF0ZUNoYW5nZSIsImV2ZW50Iiwic2VuZFJlYWR5U2lnbmFsIiwic2Vzc2lvbkVycm9yIiwiZ2V0U2Vzc2lvbiIsImluaXRpYWxpemVTdXBhYmFzZSIsImtlZXBBbGl2ZUludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJjYXRjaCIsIl8iLCJzZWxmIiwiY2xlYXJJbnRlcnZhbCJdLCJzb3VyY2VSb290IjoiIn0=